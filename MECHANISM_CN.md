# 协议机制 (Protocol Mechanics) - 开发者/高级用户视角

截止7月26日，BLend这个协议目前注重于5个模块：Supply, Borrow, Repay, Withdraw和Liquidate。也就是一个普通正常借贷协议应该要有的最基本的模样。这个文档将呈现这些模块的每一个步骤。

## 🛠 Supply 逻辑

当用户将资产存入协议时，系统会依照以下流程处理：

1. **校验输入数量**  
   确保 `NumTokens > 0`，0 数量无效。

2. **验证池子存在**  
   确认用户指定的 `token_id` 所对应的池子已创建。

3. **检查池子剩余容量**  
   确保当前池子仍有足够空间：  
   `（最大容量 - 当前容量）≥ 用户输入数量`

4. **更新池子余额**  
   将用户提交的资产加入对应的池子中。

5. **记录用户供款信息**  
   更新用户的供款记录，同时更新池子的代币余额。

## 🛠 Borrow 逻辑

当用户尝试借出资产时，系统执行以下步骤以确保借款安全合规：

1. **校验输入数量**  
   确保 `NumTokens > 0`，否则拒绝请求。

2. **验证池子存在性**  
   检查用户指定的 `token_id` 是否已对应可用池子。

3. **校验抵押资产合法性**  
   检查用户已存入的抵押资产是否满足该池子的支持条件（例如是否接受 ICP/BTC/ETH 等）。

4. **计算最大可借金额**  
   根据用户抵押资产的价值、清算门槛、当前借款状态等因素，计算 `MaxBorrowableAmount`。

5. **校验请求金额是否合规**  
   验证：`NumTokens ≤ MaxBorrowableAmount`，防止过度借款。

6. **从池子中放款**  
   若资金充足，从对应池子中扣除借款金额，转账至用户地址。

7. **更新用户借款状态**  
   增加用户的 `BorrowedAmount`，并记录初始利息开始计息时间等信息。

## 🔁 Repay（还款）

当用户发起还款操作时，系统将按照以下标准流程进行处理：

1. **校验输入金额**  
   确保还款金额 `NumTokens` 大于 0，避免无效交易。

2. **验证借贷池是否存在**  
   检查输入的 `token_id`是否对应现有支持的借贷池。

3. **确认用户是否存在未偿还借款**  
   系统将确认用户在该池中确实存在有效的借款记录。

4. **计算最大应还金额**  
   包括本金与累计应付利息，确保用户明确其总债务情况。

5. **校验还款金额不超额**  
   输入的还款金额不得超过用户当前应还金额，避免处理多余资金。

6. **执行还款操作**  
   将资产转入对应借贷池，系统将优先偿还累计利息，剩余部分用于归还本金。

7. **更新借款利率模型**  
   根据还款后池子的最新利用率，系统将动态调整利率，保持市场激励机制的平衡。

8. **更新用户借款记录与健康因子**  
   系统将同步更新用户的债务信息，并重新计算健康因子，以反映其账户安全状态。

## 🧾 Withdraw（提现操作流程）

提现流程不只是把钱取出来那么简单，系统可不傻，它得层层确认你是真有钱可取，不能白给。

1. **检查输入是否合法**  
   确保你输入的 `NumTokens > 0`，别想着提空气。

2. **验证池子是否存在**  
   检查对应的 `token_id` 是否真的有池子，不然你是对空气说话。

3. **确认你真的有存款**  
   系统会看你是否在这个池子里确实存了币，可别碰瓷。

4. **计算你最多可以提取的金额**  
   系统考虑了你是否借过钱、有没有被部分占用，只会让你提取安全范围内的资产。

5. **检查你想提的有没有超过最大值**  
   提太多？不行，超出了你该拿的部分，系统会喊停。

6. **检查该部分资产是否未被抵押**  
   若你的存款有一部分正背着债务跑，别指望现在能拿回。

7. **从池子划拨资产给你**  
   一切检查通过后，系统才会把对应 `NumTokens` 从池子转到你钱包。

8. **更新用户与池子的状态数据**  
   系统将同步更新你的 `Supply` 状态以及池子的可用余额。

## 💥 Liquidate（清算机制）

当借款人的账户健康因子低于协议设定的清算阈值，系统将允许第三方清算人介入，进行债务清算操作。以下为标准执行流程：

1. **检查借款人是否存在**  
   验证目标地址是否为合法账户，并确认其存在未偿还的借款记录。

2. **计算健康因子（Health Factor）**  
   根据抵押品价值、清算门槛、借款总额与累计利息，评估用户的账户健康状态。若健康因子 **小于 1**，则触发清算流程。

3. **计算清算人需支付的金额**  
   基于当前借款人的负债总额，确定清算人若要全额清算所需支付的资产金额（通常包含一定比例的奖励激励）。

4. **计算清算人可获得的最大抵押品数量**  
   根据协议设定的清算折扣比例（Liquidation Bonus），计算清算人可按折价获取的抵押资产上限。

5. **执行清算操作**  
   清算人偿还借款人的部分或全部债务，协议将相应抵押品按比例转移至清算人账户。

6. **更新系统状态**  
   协议实时更新被清算人的 `Borrow` 与 `Supply` 状态，同时同步池子的总资产与可用流动性信息。

## 🧠 我们为什么使用 Pyth Network？

我们选择 **Pyth Network** 作为预言机提供方，主要原因是我们后端的工程师是个精打细算的务实派。刚好 **Pyth 是开源免费的**，他也之前用过，自然就毫不犹豫地采用了。

虽然 **ICP 自身也有原生的预言机服务**，但整体费用相对较高。而调用 Pyth Network 的成本只在执行智能合约时才会产生费用，这能大大节省我们的运行成本。

当然，我们也充分考虑了 **安全性与可靠性**——Pyth 作为主流预言机之一，具备良好的口碑与成熟的技术架构。


## 📈 价格更新频率与机制

- **前端**：每秒自动刷新，确保用户看到的是最新价格；
- **后端**：仅在执行诸如 `借款` 或 `还款` 等敏感操作时才更新价格，确保公平、准确。

这种前端实时+后端按需的模式，**兼顾了用户体验与 gas 成本的效率**。


## 🚨 预言机故障应对机制

一旦发现预言机数据异常或无法获取，**我们会立即暂停所有与资产转移相关的核心合约操作**（如借款、还款、提现等），以防止资金损失。

我们的技术团队 **全天候在线**，能在第一时间介入处理，最大程度保障用户与协议的安全。

> 🛡️ 风控优先，安全第一。
